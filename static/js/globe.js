var DAT=DAT||{};DAT.Globe=function(e,t){function n(){e.style.color="#fff",e.style.font="13px/20px Arial, sans-serif";var t,n,i;x=e.offsetWidth||window.innerWidth,T=e.offsetHeight||window.innerHeight,E=new THREE.PerspectiveCamera(30,x/T,1,1e4),E.position.z=j,g=new THREE.Scene;var o=new THREE.SphereGeometry(200,40,30);t=H.earth,n=THREE.UniformsUtils.clone(t.uniforms),n.texture.value=THREE.ImageUtils.loadTexture(R+"world_states_blood.jpg"),i=new THREE.ShaderMaterial({uniforms:n,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),w=new THREE.Mesh(o,i),w.rotation.y=Math.PI,g.add(w),t=H.atmosphere,n=THREE.UniformsUtils.clone(t.uniforms),i=new THREE.ShaderMaterial({uniforms:n,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,side:THREE.BackSide,blending:THREE.AdditiveBlending,transparent:!0}),w=new THREE.Mesh(o,i),w.scale.set(1.1,1.1,1.1),g.add(w),o=new THREE.CubeGeometry(.75,.75,1),o.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,-.5)),_=new THREE.Mesh(o),y=new THREE.WebGLRenderer({antialias:!0}),y.setSize(x,T),y.domElement.style.position="absolute",e.appendChild(y.domElement),e.addEventListener("mousedown",a,!1),e.addEventListener("mousewheel",d,!1),document.addEventListener("keydown",l,!1),window.addEventListener("resize",v,!1),e.addEventListener("mouseover",function(){M=!0},!1),e.addEventListener("mouseout",function(){M=!1},!1)}function o(){if(void 0!==this._baseGeometry){if(this.is_animated===!1)this.points=new THREE.Mesh(this._baseGeometry,new THREE.MeshBasicMaterial({color:16777215,vertexColors:THREE.FaceColors,morphTargets:!1}));else{if(this._baseGeometry.morphTargets.length<8){console.log("t l",this._baseGeometry.morphTargets.length);var e=8-this._baseGeometry.morphTargets.length;console.log("padding",e);for(var t=0;e>=t;t++)console.log("padding",t),this._baseGeometry.morphTargets.push({name:"morphPadding"+t,vertices:this._baseGeometry.vertices})}this.points=new THREE.Mesh(this._baseGeometry,new THREE.MeshBasicMaterial({color:16777215,vertexColors:THREE.FaceColors,morphTargets:!0}))}g.add(this.points)}}function r(e,t,n,i,o){var r=(90-e)*Math.PI/180,a=(180-t)*Math.PI/180;_.position.x=200*Math.sin(r)*Math.cos(a),_.position.y=200*Math.cos(r),_.position.z=200*Math.sin(r)*Math.sin(a),_.lookAt(w.position),_.scale.z=Math.max(n,.1),_.updateMatrix();for(var s=0;s<_.geometry.faces.length;s++)_.geometry.faces[s].color=i;THREE.GeometryUtils.merge(o,_)}function a(t){t.preventDefault(),e.addEventListener("mousemove",s,!1),e.addEventListener("mouseup",m,!1),e.addEventListener("mouseout",h,!1),S.x=-t.clientX,S.y=t.clientY,I.x=D.x,I.y=D.y,e.style.cursor="move"}function s(e){G.x=-e.clientX,G.y=e.clientY;var t=j/1e3;D.x=I.x+.005*(G.x-S.x)*t,D.y=I.y+.005*(G.y-S.y)*t,D.y=D.y>C?C:D.y,D.y=D.y<-C?-C:D.y}function m(t){e.removeEventListener("mousemove",s,!1),e.removeEventListener("mouseup",m,!1),e.removeEventListener("mouseout",h,!1),e.style.cursor="auto"}function h(t){e.removeEventListener("mousemove",s,!1),e.removeEventListener("mouseup",m,!1),e.removeEventListener("mouseout",h,!1)}function d(e){return e.preventDefault(),M&&c(.3*e.wheelDeltaY),!1}function l(e){switch(e.keyCode){case 38:c(100),e.preventDefault();break;case 40:c(-100),e.preventDefault()}}function v(e){E.aspect=window.innerWidth/window.innerHeight,E.updateProjectionMatrix(),y.setSize(window.innerWidth,window.innerHeight)}function c(e){P-=e,P=P>1e3?1e3:P,P=350>P?350:P}function u(){requestAnimationFrame(u),f()}function f(){c(b),L.x+=.1*(D.x-L.x),L.y+=.1*(D.y-L.y),j+=.3*(P-j),E.position.x=j*Math.sin(L.x)*Math.cos(L.y),E.position.y=j*Math.sin(L.y),E.position.z=j*Math.cos(L.x)*Math.cos(L.y),E.lookAt(w.position),y.render(g,E)}function p(e,t){var n,i;if(t instanceof THREE.Mesh)for(n=e.__webglObjects.length-1;n>=0;n--)if(i=e.__webglObjects[n].object,t==i)return void e.__webglObjects.splice(n,1)}t=t||function(e){var t=new THREE.Color;return t.setHSL(.6-.5*e,1,.5),t};var E,g,y,x,T,w,_,M,H={earth:{uniforms:{texture:{type:"t",value:null}},vertexShader:["varying vec3 vNormal;","varying vec2 vUv;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","vNormal = normalize( normalMatrix * normal );","vUv = uv;","}"].join("\n"),fragmentShader:["uniform sampler2D texture;","varying vec3 vNormal;","varying vec2 vUv;","void main() {","vec3 diffuse = texture2D( texture, vUv ).xyz;","float intensity = 1.05 - dot( vNormal, vec3( 0.0, 0.0, 1.0 ) );","vec3 atmosphere = vec3( 1.0, 1.0, 1.0 ) * pow( intensity, 3.0 );","gl_FragColor = vec4( diffuse + atmosphere, 1.0 );","}"].join("\n")},atmosphere:{uniforms:{},vertexShader:["varying vec3 vNormal;","void main() {","vNormal = normalize( normalMatrix * normal );","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec3 vNormal;","void main() {","float intensity = pow( 0.8 - dot( vNormal, vec3( 0, 0, 1.0 ) ), 12.0 );","gl_FragColor = vec4( 1.0, 1.0, 1.0, 1.0 ) * intensity;","}"].join("\n")}},R="/static/jpg/",b=0,G={x:0,y:0},S={x:0,y:0},L={x:0,y:0},D={x:1*Math.PI,y:Math.PI/4.5},I={x:0,y:0},j=1e5,P=1e5,C=Math.PI/2;return addData=function(e,n){var i,o,a,s,m,h,d;if(n.animated=n.animated||!1,this.is_animated=n.animated,n.format=n.format||"magnitude",console.log(n.format),"magnitude"===n.format)h=3,d=function(e,n){return t(e[n+2])};else{if("legend"!==n.format)throw"error: format not supported: "+n.format;h=4,d=function(e,n){return t(e[n+3])}}if(n.animated){if(void 0===this._baseGeometry)for(this._baseGeometry=new THREE.Geometry,m=0;m<e.length;m+=h)i=e[m],o=e[m+1],s=d(e,m),a=0,r(i,o,a,s,this._baseGeometry);void 0===this._morphTargetId?this._morphTargetId=0:this._morphTargetId+=1,n.name=n.name||"morphTarget"+this._morphTargetId}var l=new THREE.Geometry;for(m=0;m<e.length;m+=h)i=e[m],o=e[m+1],s=d(e,m),a=e[m+2],a>0&&(a=200*a,r(i,o,a,s,l));n.animated?this._baseGeometry.morphTargets.push({name:n.name,vertices:l.vertices}):this._baseGeometry=l},n(),this.animate=u,this.__defineGetter__("time",function(){return this._time||0}),this.__defineSetter__("time",function(e){var t=[],n=this.points.morphTargetDictionary;for(var o in n)o.indexOf("morphPadding")<0&&t.push(n[o]);t.sort();var r=t.length-1,a=e*r+1,s=Math.floor(a);for(i=0;i<t.length;i++)this.points.morphTargetInfluences[t[i]]=0;var m=s-1,h=a-s;m>=0&&(this.points.morphTargetInfluences[m]=1-h),this.points.morphTargetInfluences[s]=h,this._time=e}),this.resetData=function(){void 0!==this.points&&(this.scene.remove(this.points),p(this.scene,this.points),p(this.scene,this.points))},this.addData=addData,this.createPoints=o,this.renderer=y,this.scene=g,this};
